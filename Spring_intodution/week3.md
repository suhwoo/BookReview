## ch.18 h2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜
https://www.h2database.com/html/main.html  
h2 windowë¡œ ì„¤ì¹˜í•œë’¤ ì••ì¶• í•´ì œ -> windowì˜ ê²½ìš°, h2.shê°€ ì•„ë‹ˆë¼ h2.batìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•œë‹¤.  

ğŸ¥•ì—°ê²° ëˆ„ë¥¼ë•Œ ë§Œì•½ "192. ...  ì—ì„œ ì—°ê²°ì´ ì•ˆë©ë‹ˆë‹¤"ê°€ ëœ¬ë‹¤ë©´ ê°œì¸ ì™€ì´íŒŒì´ë¡œ ë‹¤ì‹œ í•´ë³¼ê²ƒ.. ì¹´í˜ ì™€ì´íŒŒì´ì—ì„œëŠ” ì°¨ë‹¨ë˜ëŠ” ë“¯í•˜ë‹¤.  

jdbc:h2:~/test ë¡œ í•˜ë©´ ë‚˜ì¤‘ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë‘ ì¶©ëŒë˜ì„œ ì•ˆë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ

jdbc:h2:tcp://localhost/~/test ì´ë ‡ê²Œ ì—°ê²°í•œë‹¤.  
```sql
create table member
(
    id bigint generated by default as identity,
    name varchar(255),
    primary key (id)
);
```  
í•˜ë©´ memberì´ë¼ëŠ” tableì´ ìƒê¸´ë‹¤.  
generated by default as identity -> nullì´ ë“¤ì–´ì˜¤ë©´ dbê°€ ìë™ìœ¼ë¡œ idê°’ì„ ì±„ì›Œì¤€ë‹¤.  
  
íŒŒì¼ ë°–ì— sql íŒŒì¼ í•˜ë‚˜ ë§Œë“¤ê³  sqlì„ ê´€ë¦¬í•˜ê¸°ë„ í•œë‹¤.  
  
## ch.19 ìˆœìˆ˜ jdbc  
ì´ì œ dbì— ë„£ê³  ë¹¼ê³  í•´ë³´ì  
ê³ ëŒ€ì˜ ë°©ë²•.  
  
build.gradleì— ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í•œë‹¤.  
```
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```
ìœ„ì—ëŠ” ì¼ë‹¨ javaëŠ” dbë‘ ë¶™ìœ¼ë ¤ë©´ ê¼­ jdbcë‘ ì—°ê²°ì„ í•´ì¤˜ì•¼ í•œë‹¤.  
ì•„ë˜ëŠ” ì´ì œ dbë‘ ë¶™ì„ë•Œ databaseê°€ ì œê³µí•˜ëŠ” clientê°€ í•„ìš”í•˜ë‹¤.  
  
ì ‘ì†ì •ë³´ëŠ” resourcesì˜ application.propertiesì— pathì •ë³´ë¥¼ ì¶”ê°€í•œë‹¤.  
```
spring.datasource.url= jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
```  
ì´ì œ ì¸ë©”ëª¨ë¦¬ ë§ê³  databaseì— ì €ì¥í•  ìˆ˜ ìˆë„ë¡ jdbcMemberRepositoryë¥¼ ë§Œë“ ë‹¤.  
```java
package hello.hellospring.repository;

import hello.hellospring.domain.Member;
import org.springframework.jdbc.datasource.DataSourceUtils;


import javax.sql.DataSource;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

public class JdbcMemberRepository implements MemberRepository {
    private final DataSource dataSource;
    public JdbcMemberRepository(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    @Override
    public Member save(Member member) {
        String sql = "insert into member(name) values(?)";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();//databaseì— ì—°ê²°
            pstmt = conn.prepareStatement(sql,
                    Statement.RETURN_GENERATED_KEYS);
            pstmt.setString(1, member.getName());
            pstmt.executeUpdate();//dbë¡œ queryê°€ ë‚ ì•„ê°„ë‹¤.
            rs = pstmt.getGeneratedKeys();//dbê°€ ìƒì„±í•œ í‚¤ë¥¼ ë°˜í™˜í•œë‹¤. (ì§€ê¸ˆì€ ID)
            if (rs.next()) {//
                member.setId(rs.getLong(1));
            } else {
                throw new SQLException("id ì¡°íšŒ ì‹¤íŒ¨");
            }
            return member;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }
    @Override
    public Optional<Member> findById(Long id) {
        String sql = "select * from member where id = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setLong(1, id);
            rs = pstmt.executeQuery();
            if(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            } else {
                return Optional.empty();
            }
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }
    @Override
    public List<Member> findAll() {
        String sql = "select * from member";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            rs = pstmt.executeQuery();
            List<Member> members = new ArrayList<>();
            while(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                members.add(member);
            }
            return members;
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }
    @Override
    public Optional<Member> findByName(String name) {
        String sql = "select * from member where name = ?";
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        try {
            conn = getConnection();
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, name);
            rs = pstmt.executeQuery();
            if(rs.next()) {
                Member member = new Member();
                member.setId(rs.getLong("id"));
                member.setName(rs.getString("name"));
                return Optional.of(member);
            }
            return Optional.empty();
        } catch (Exception e) {
            throw new IllegalStateException(e);
        } finally {
            close(conn, pstmt, rs);
        }
    }
    private Connection getConnection() {
        return DataSourceUtils.getConnection(dataSource);
    }
    private void close(Connection conn, PreparedStatement pstmt, ResultSet rs)
    {
        try {
            if (rs != null) {
                rs.close();//resourceë¥¼ ê±°ê¾¸ë¡œ closeë„ í•´ì¤˜ì•¼ í•œë‹¤.
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (pstmt != null) {
                pstmt.close();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        try {
            if (conn != null) {
                close(conn);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    private void close(Connection conn) throws SQLException {
        DataSourceUtils.releaseConnection(conn, dataSource);
    }
}

```  
ì£¼ëª©í•´ì•¼ í•  ë¶€ë¶„ì€ ì´ ë’·ë¶€ë¶„ì´ë‹¤.  
Spring config íŒŒì¼ì—ì„œ  
```java
package hello.hellospring;

import hello.hellospring.repository.JdbcMemberRepository;
import hello.hellospring.repository.MemberRepository;
import hello.hellospring.repository.MemoryMemberRepository;
import hello.hellospring.service.MemberService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;

@Configuration
public class SpringConfig {

    private DataSource dataSource;
    @Autowired
    public SpringConfig(DataSource dataSource){
        this.dataSource = dataSource;
    }

    @Bean
    public MemberService memberService(){
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository(){
        return new JdbcMemberRepository(dataSource);
    }
}

```
ë‹¤ìŒê³¼ ê°™ì´ dataSourceë¥¼ ì¶”ê°€í•˜ê³  Beanë§Œ JdbcMemberRepositoryë¡œ ë°”ê¿ˆìœ¼ë¡œì¨ ë‹¤ë¥¸ ì½”ë“œë¥¼ ì†ëŒ€ì§€ ì•Šê³  dbë¥¼ ë°”ê¿€ ìˆ˜ ìˆë‹¤.  

![image](https://user-images.githubusercontent.com/61738600/139525038-ce22ffa3-0909-45f8-8a43-ffa781b498cf.png)

  
ğŸ¥• íšŒì›ë“±ë¡ì„ í–ˆì„ë•Œ ì—ëŸ¬ í˜ì´ì§€ê°€ ë‚˜ì˜¤ëŠ” 'Wrong user name or password'ë¬¸ì œê°€ ìƒê¸°ëŠ”ë°   
ìŠ¤í”„ë§ë¶€íŠ¸ 2.4 ë¶€í„°ëŠ” resources->propertiesì— spring.datasource.username=sa ë¥¼ ì¶”ê°€í•´ì¤˜ì•¼ í•œë‹¤.  

  
## ch.20 ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸  
ì´ì   testë„ springê³¼ ì—°ê²°í•´ì„œ í•´ì•¼í•œë‹¤.ì´ì œ dbë„ springì´ ê´€ë¦¬í•˜ê³  ìˆê¸° ë•Œë¬¸ì—  

ì›ë˜ëŠ” ì„œë¹„ìŠ¤, ë ˆí¬ë¥¼ ì§ì ‘ ìƒì„±í–ˆì§€ë§Œ ì´ì œëŠ” spring containerì—ê²Œì„œ ë°›ì•„ì˜¬ ê²ƒì´ë‹¤.  
```java
package hello.hellospring.service;

import hello.hellospring.domain.Member;
import hello.hellospring.repository.MemberRepository;
import hello.hellospring.repository.MemoryMemberRepository;
import org.junit.jupiter.api.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
@Transactional
/*ì›ë˜ëŠ” testí›„ì— dbì— ë°ì´í„°ê°€ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì— ê°™ì€ ë°ì´í„°ë¡œ ë„£ìœ¼ë©´ ì¤‘ë³µìœ¼ë¡œ ì²˜ë¦¬ëœë‹¤.
* Transactionalì„ ë„£ìœ¼ë©´ testê°€ ëë‚œí›„ì— dbì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ rollbackí•´ì¤€ë‹¤.*/
class MemberServiceIntegrationTest {


    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;//í˜„ì¬ springì— ë“±ë¡ë˜ì–´ ìˆëŠ” configurationì—ì„œ ì˜¬ë¼ì˜¨ë‹¤.

    @Test
    void join() {
        //given
        Member member = new Member();
        member.setName("hello");
        //when
        Long saveId = memberService.join(member);
        //then
        Member findMember = memberService.findOne(saveId).get();
        Assertions.assertEquals(member.getName(),findMember.getName());
    }

    @Test
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸(){
        //given
        Member member1 = new Member();
        member1.setName("spring");

        Member member2 = new Member();
        member2.setName("spring");
        //when
        memberService.join(member1);
        IllegalStateException e = assertThrows(IllegalStateException.class,()->memberService.join(member2));
        assertEquals(e.getMessage(),"ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
        /**
         try{
         memberService.join(member2);
         fail();
         }catch(IllegalStateException e){
         assertEquals(e.getMessage(),"ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
         }**/
        //then
    }


}
```  
ë‹¤ë§Œ ì—­ì‹œ spring ì•ˆ ëœ¨ëŠ” í…ŒìŠ¤íŠ¸ê°€ ë”ë¹ ë¥´ë‹¤. ì´ëŸ¬í•œ í…ŒìŠ¤íŠ¸ë¥¼ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë¼ê³  ë¶€ë¥¸ë‹¤. (spring containerì„ ì‚¬ìš©í•œê²ƒì„ í†µí•©í…ŒìŠ¤íŠ¸) ë³´í†µ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë¥¼ ì˜ ë§Œë“  í…ŒìŠ¤íŠ¸ë¼ê³  í•œë‹¤.  
  
## ch.21 ìŠ¤í”„ë§ JdbcTemplate  
JdbcTemplateì€ ë°˜ë³µì ì¸ ì½”ë“œë¥¼ ì œê±°í•´ì¤€ë‹¤.  
```java
package hello.hellospring.repository;

import hello.hellospring.domain.Member;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.simple.SimpleJdbcInsert;

import javax.sql.DataSource;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

public class JdbcTemplateMemberRepository implements MemberRepository{

    private final JdbcTemplate jdbcTemplate;

    @Autowired//ì‚¬ì‹¤ ìƒì„±ìê°€ í•˜ë‚˜ì¼ë•ŒëŠ” Autowired ìƒëµí•´ë„ ëœë‹¤.
    public JdbcTemplateMemberRepository(DataSource dataSource){
        jdbcTemplate = new JdbcTemplate(dataSource);
    }

    @Override
    public Member save(Member member) {
        SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
        jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");
        //ì´ë ‡ê²Œ ë„£ìœ¼ë©´ ì¿¼ë¦¬ ìì²´ë¥¼ ì§¤ í•„ìš”ê°€ ì—†ë‹¤. ê·¸ëƒ¥ insetê°€ ë§Œë“¤ì–´ì§.
        Map<String, Object> parameters = new HashMap<>();
        parameters.put("name", member.getName());

        Number key = jdbcInsert.executeAndReturnKey(new
                MapSqlParameterSource(parameters));
        member.setId(key.longValue());
        return member;
    }

    @Override
    public Optional<Member> findById(Long id) {
        List<Member> result = jdbcTemplate.query("select * from member where id = ?",memberRowMapper(),id);
        //ê²°ê³¼ë¥¼ rowMapperë¡œ ë§¤í•‘.
        return result.stream().findAny();
        //ë‹¨ 2ì¤„ë¡œ ì¤„ì¼ ìˆ˜ ìˆë‹¤. ë””ìì¸ íŒ¨í„´ ì¤‘ì— template method íŒ¨í„´ì— í•´ë‹¹.
    }

    @Override
    public Optional<Member> findByName(String name) {
        List<Member> result = jdbcTemplate.query("select * from member where name = ?",memberRowMapper(),name);
        return result.stream().findAny();
    }

    @Override
    public List<Member> findAll() {
        return jdbcTemplate.query("select * from member",memberRowMapper());
    }
    private RowMapper<Member> memberRowMapper(){
        return (rs, rowNum) -> {
            Member member = new Member();
            member.setId(rs.getLong("id"));
            member.setName(rs.getString("name"));
            return member;

        };
    }
}

```
Jdbc templateì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ template documentë‚˜ í›„ì— dbì—°ê²°ë•Œ ì´ì–´ì„œ..  
  
## ch.22 JPA  
JdbcTemplateìœ¼ë¡œ ë°”ê¿¨ì„ë•Œ ë°˜ë³µë˜ëŠ” ì½”ë“œê°€ ì¤„ì—ˆëŠ”ë° JPAë¥¼ ì‚¬ìš©í•˜ë©´ ë°˜ë³µì ì¸ ì¿¼ë¦¬ë„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.  
DBì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê³  ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ëŠ” ê²ƒì€ JPAê°€ ì²˜ë¦¬í•´ì¤€ë‹¤.  
JPA ë¥¼ ì‚¬ìš©í•˜ë©´ ë°ì´í„° ì¤‘ì‹¬ ì„¤ê³„ì—ì„œ ê°ì²´ ì¤‘ì‹¬ì˜ ì„¤ê³„ë¥¼ í•  ìˆ˜ ìˆë‹¤.  
```java
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
```  
gradleì— data-jpa ì¶”ê°€í•œë‹¤. jpaë„ í¬í•¨í•˜ê³  jdbcë„ í¬í•¨ëœë‹¤.  
ë¼ì´ë¸ŒëŸ¬ë¦¬ì— jpaì™€ hibernateê°€ ë“¤ì–´ì™€ì•¼ í•˜ëŠ”ë° jpaê°€ ì¸í„°í˜ì´ìŠ¤ê³  êµ¬í˜„ì²´ê°€ hibernateì´ë‹¤.  
```java
package hello.hellospring.domain;

import javax.persistence.*;

@Entity
public class Member {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY) //dbê°€ ì•Œì•„ì„œ idìƒì„±
    private Long id;
    private String name;

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}

```
jpaëŠ” ormì´ë¼ëŠ” ê¸°ìˆ ì¸ë° oëŠ” ê°ì²´ rì€ ê´€ê³„í˜•, m mapping.  
ì•„ë˜ëŠ” ë ˆí¬  
```java
package hello.hellospring.repository;

import hello.hellospring.domain.Member;

import javax.persistence.Entity;
import javax.persistence.EntityManager;
import java.util.List;
import java.util.Optional;

public class JpaMemberRepository implements MemberRepository{

    private final EntityManager em;
    //jpaëŠ” entitymanagerë¡œ ë™ì‘í•œë‹¤. speing bootê°€ emì„ ë§Œë“¤ì–´ ì£¼ëŠ”ë° ìš°ë¦¬ëŠ” ì´ê±¸ injectionë°›ìœ¼ë©´ ëœë‹¤.

    public JpaMemberRepository(EntityManager em){
        this.em = em;
    }

    @Override
    public Member save(Member member) {
        em.persist(member);
        return member;
    }

    @Override
    public Optional<Member> findById(Long id) {
        Member member=em.find(Member.class,id);
        return Optional.ofNullable(member);
    }

    @Override
    public Optional<Member> findByName(String name) {
        List<Member> result = em.createQuery("select m from Member m where m.name=:name",Member.class)
                .setParameter("name",name)
                .getResultList();
        return result.stream().findAny();
    }

    @Override
    public List<Member> findAll() {
        //ê°ì²´(Member entity)ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦°ë‹¤.
        return em.createQuery("select m from Member m",Member.class).getResultList();
        //member entity ìì²´ì—ì„œ ì°¾ëŠ”ë‹¤.
    }
}

```
jpaëŠ” ì‹¤í–‰ë ë•Œ í•­ìƒ Transactionë‚´ì—ì„œ ì‹¤í–‰ë˜ì•¼ í•œë‹¤.  
```java
package hello.hellospring.service;

import hello.hellospring.domain.Member;
import hello.hellospring.repository.MemberRepository;
import hello.hellospring.repository.MemoryMemberRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;

@Transactional//ì´ë¶€ë¶„ ì¶”ê°€
public class MemberService {

    private  final MemberRepository memberRepository;

    public MemberService(MemberRepository memberRepository){
        this.memberRepository=memberRepository;
    }

    //íšŒì›ê°€ì…
    public Long join(Member member){
        //ê°™ì€ ì´ë¦„ì¸ ì¤‘ë³µì´ë¦„ì€ ì•ˆëœë‹¤.
        validateDuplicateMember(member);

        memberRepository.save(member);
        return member.getId();
    }

    private void validateDuplicateMember(Member member) {
        memberRepository.findByName(member.getName())
                .ifPresent(m ->{
                        throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
                });
    }

    //ì „ì²´íšŒì›ì¡°íšŒ
    public List<Member> findMembers(){
        return memberRepository.findAll();
    }

    public  Optional<Member> findOne(Long memberId){
        return memberRepository.findById(memberId);
    }
}

```  
SpringConfigì—ë„ datasourceë§ê³  emì´ í•„ìš”í•˜ë‹¤.  
```
package hello.hellospring;

import hello.hellospring.repository.*;
import hello.hellospring.service.MemberService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.persistence.EntityManager;
import javax.sql.DataSource;

@Configuration
public class SpringConfig {

    private EntityManager em;

    @Autowired
    public  SpringConfig(EntityManager em){
        this.em = em;
    }
    //private DataSource dataSource;
    //@Autowired
    //public SpringConfig(DataSource dataSource){
    //    this.dataSource = dataSource;
    //}

    @Bean
    public MemberService memberService(){
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository(){
       // return new JdbcMemberRepository(dataSource);
        // return new JdbcTemplateMemberRepository(dataSource);
        return new JpaMemberRepository(em);
    }
}

```



